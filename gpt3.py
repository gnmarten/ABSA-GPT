import os
import openai
from textwrap import dedent

openai.api_key = os.getenv("OPENAI_API_KEY")

ABSA_PROMPT = dedent(
    f"""
    First, identify the language of the utterance. Please classify the following text in terms of \"Aspect Category\", \"Aspect Term\", \"Opinion Target\", \"Opinion Expression\", \"Sentiment\" and \"Confidence Score\" using the original language of the text. Do not invent \"Aspect Category\" or \"Aspect Term\" yourself. The aspect categories and their terms are: \"TEXT: Title\", \"TEXT:  Quote\", \"TEXT: PoV_Narration\", \"TEXT: Motifs_Themes\", \"TEXT: Language_Style_\", \"TEXT: General-Content_Plot\", \"TEXT: General\", \"TEXT: Form\", \"TEXT: Flow_Rhythm_Punctuation\", \"TEXT: Characters\", \"READING: Pronunciation_Intonation_Understandability\", \"READING: General\", \"READING: Flow_Rhythm_Punctuation\", \"ONSITE-AUDIENCE: General\", \"ONSITE-AUDIENCE: Behaviour\", \"ONSITE-AUDIENCE: Appearance_Clothing\", \"ONSITE-AUDIENCE: Age\", \"META: Winner_Award-Ceremony\", \"META: Weather\", \"META: Voting\", \"META: Videoportrait\", \"META: Technology_Social-Media\", \"META: Side-Event\", \"META: Shortlist\", \"META: Opening-Speech\", \"META: Online-Assessment\", \"META: Music\", \"META: Montage\", \"META: Main-Event\", \"META: Longlist\", \"META: Location\", \"META: Literature_Literary-Prizes\", \"JURY: Voice_Language-Use\", \"JURY: Quote\", \"JURY: General\", \"JURY: Discussion_Valuation\", \"JURY: Behaviour\", \"JURY: Appearance_Clothing\", \"CONTENDER: Quote\", \"CONTENDER: General\", \"CONTENDER: Gender\", \"CONTENDER: Appearance_Clothing\", \"ALLO-REFERENCES: TEXT_Other-Text\", \"ALLO-REFERENCES: TEXT_Other-Author\", \"ALLO-REFERENCES: SCREEN_Film_Tv\", \"ALLO-REFERENCES: SCREEN_Director_Actor\", \"ALLO-REFERENCES: MUSIC_Musician\", \"ALLO-REFERENCES: General\". Any reference to one of the names Winkels, Gmünder, Kegel, Kastberger, Keller, Feßmann, Steiner needs to be classified as \"JURY: Name\". Any reference to either one of the following names needs to be classified as \"CONTENDER: Name\": Dinić, Dorian, Gardi, Lehn, Macht, Özdogan, Otoo, Sargnagel, Schenk, Schneider, Snela, Sozio, Wolf, Zwicky. Any reference to any other named entity persons is to be seen as belonging to the Aspect Category \"ALLO-REFERENCE\". The Sentiment is  \"positive\", \"neutral\" or \"negative\". The numeric confidence score ranges between -1 and 1 and is rounded to hundreds and tens. Format output as JSON. Ignore the hashtags and the weblinks.\n\n    der Akzent des Autors ist so sympathisch. Aber dieser Juror, der da redet. Dieser selbstgefällige kleine Meckerer. Der fängt an, zu nerven. Wray performt zu viel mit den Händen. Das lenkt zu sehr vom Text ab #tddl Sargnagel hat eine technisch, intellektuell und literarisch hervorragende Geschichte abgeliefert. Statt Thomas Bernhard werden Parallelen zu Wolf Haas gezogen. Auch das ist wohltuend an der Diskussion\n\n    [\n      {{ \"aspect category\": \"CONTENDER\", \"aspect term\": \"Appearance_Clothing\", \"opinion target\": \"Akzent des Autors\", \"opinion expression\": \"ist so sympathisch\", \"sentiment\": \"positive\", \"confidence score\": \"1\" }},\n      {{ \"aspect category\": \"JURY\", \"aspect term\": \"Behaviour\", \"opinion target\": \"dieser Juror, der da redet\", \"opinion expression\": \"Dieser selbstgefällige kleine Meckerer\", \"sentiment\": \"negative\", \"confidence score\": \"-1\" }},\n      {{ \"aspect category\": \"JURY\", \"aspect term\": \"Behaviour\", \"opinion target\": \"dieser Juror, der da redet\", \"opinion expression\": \"fängt an, zu nerven\", \"sentiment\": \"negative\", \"confidence score\": \"-1\" }},\n      {{ \"aspect category\": \"CONTENDER\", \"aspect term\": \"Appearance_Clothing\", \"opinion target\": \"Sargnagel\", \"opinion expression\": \"performt zu viel mit den Händen\", \"sentiment\": \"negative\", \"confidence score\": \"-0.7\" }},\n      {{ \"aspect category\": \"TEXT\", \"aspect term\": \"Language_Style\", \"opinion target\": \"Geschichte\", \"opinion expression\": \"technisch, intellektuell und literarisch hervorragende\", \"sentiment\": \"positive\", \"confidence score\": \"0.7\" }},\n      {{ \"aspect category\": \"ALLO-REFERENCE\", \"aspect term\": \"Other-Author\", \"opinion target\": \"werden Parallelen zu Wolf Haas gezogen\", \"opinion expression\": \"das ist wohltuend an der Diskussion\", \"sentiment\": \"positive\", \"confidence score\": \"0.5\" }}\n       {{ \"aspect category\": \"ALLO-REFERENCE\", \"aspect term\": \"Other-Author\", \"opinion target\": \"Thomas Bernhard \", \"opinion expression\": \"statt\", \"sentiment\": \"negative\", \"confidence score\": \"-0.1\" }}\n    ]\n\n    Der Text handelt vom Überleben in den Konzentrationslagern und wird aus der Sicht eines unzuverlässigen Erzählers erzählt. Der Text von Peschka hingegen: Beklemmend. Dumpf. Spröde. Karg. Verstörend. Irritierend. - Ein Endspiel Eingeschlossener mit Mäusen in ihren Bunkern. - Es fröstelt mich, trotz der Hitze im Text. Eindringlich. Geduldiges Warten im Saal. Ich finde die Jury heuer so zahm und alles irgendwie gutfindend. Einige Besucher nutzen den Text als Fächer. Wahrscheinlich das Beste, was man damit machen kann.\n\n    [\n      {{ \"aspect category\": \"TEXT\", \"aspect term\": \"Motifs_Themes\", \"opinion target\": \"der Text\", \"opinion expression\": \"handelt vom Überleben in den Konzentrationslagern\", \"sentiment\": \"neutral\", \"confidence score\": \"1\" }},\n      {{ \"aspect category\": \"TEXT\", \"aspect term\": \"PoV_Narration\", \"opinion target\": \"der Text\", \"opinion expression\": \"wird aus der Sicht eines unzuverlässigen Erzählers erzählt\", \"sentiment\": \"neutral\", \"confidence score\": \"0\" }},\n      {{ \"aspect category\": \"TEXT\", \"aspect term\": \"Language_Style\", \"opinion target\": \"Der Text von Peschka\", \"opinion expression\": \"Beklemmend. Dumpf. Spröde. Karg. Verstörend. Irritierend. \", \"sentiment\": \"positiv\", \"confidence score\": \"0,3\" }},\n      {{ \"aspect category\": \"TEXT\", \"aspect term\": \"Motifs_Themes\", \"opinion target\": \"Eingeschlossener mit Mäusen in ihren Bunkern\", \"opinion expression\": \"ein Endspiel\", \"sentiment\": \"neutral\", \"confidence score\": \"0\" }},\n      {{ \"aspect category\": \"ONSITE-AUDIENCE\", \"aspect term\": \"Behaviour\", \"opinion target\": \"im Saal\", \"opinion expression\": \"Geduldiges Warten\", \"sentiment\": \"neutral\", \"confidence score\": \"0\" }}\n       {{ \"aspect category\": \"JURY\", \"aspect term\": \"valuation\", \"opinion target\": \"die Jury\", \"opinion expression\": \"heuer so zahm und alles irgendwie gutfindend\", \"sentiment\": \"negative\", \"confidence score\": \"-0,3\" }}\n       {{ \"aspect category\": \"ONSITE-AUDIENCE\", \"aspect term\": \"Behaviour\", \"opinion target\": \" Einige Besucher \", \"opinion expression\": \"nutzen den Text als Fächer.\", \"sentiment\": \"neutral\", \"confidence score\": \"0\" }}\n       {{ \"aspect category\": \"ONSITE-AUDIENCE\", \"aspect term\": \"Behaviour\", \"opinion target\": \"nutzen den Text als Fächer\", \"opinion expression\": \"das Beste, was man damit machen kann\", \"sentiment\": \"negative\", \"confidence score\": \"-0,3\" }}\n    ]
"""
)


def analyze(
    text,
    prompt_text=ABSA_PROMPT,
    extra_prompt="",
    temperature=0.5,
    max_tokens=280,
    top_p=1,
    frequency_penalty=0,
    presence_penalty=0,
):
    prompt = f"{prompt_text}\n{extra_prompt}\n{text}"

    return openai.Completion.create(
        model="text-davinci-003",
        prompt=prompt,
        temperature=temperature,
        max_tokens=max_tokens,
        top_p=top_p,
        frequency_penalty=frequency_penalty,
        presence_penalty=presence_penalty,
    )
